<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Full Stroke Module</title>
    <link rel="stylesheet" href="/0925/assets/index-DbnZbWPC.css">
    <style>
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #000;
            color: #0f0;
            font-family: monospace;
            overflow-y: auto;
            padding: 10px;
            font-size: 12px;
            z-index: 10000;
        }
        .debug-line {
            margin: 2px 0;
        }
        .error { color: #f00; }
        .warn { color: #ff0; }
        .success { color: #0f0; }
    </style>
</head>
<body>
<header class="app-header" role="banner">
    <div class="header-left">
        <button id="backButton" aria-label="Go back" title="Back" style="display: none;">‚Üê</button>
        <button id="homeButton" aria-label="Go home" title="Home">üè†</button>
    </div>
    <div class="header-content">
        <h1>iGFAP Debug</h1>
        <small class="app-subtitle">Full Stroke Module Testing</small>
    </div>
</header>

<main role="main">
    <div id="appContainer"></div>
</main>

<div id="debugPanel" class="debug-panel"></div>

<footer role="contentinfo">
    <p>Debug Mode</p>
</footer>

<script type="module">
    // Debug logging
    const debugPanel = document.getElementById('debugPanel');
    function debugLog(message, type = 'log') {
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = `debug-line ${type}`;
        line.textContent = `[${time}] ${message}`;
        debugPanel.appendChild(line);
        debugPanel.scrollTop = debugPanel.scrollHeight;

        // Also log to console
        console[type](message);
    }

    // Override console methods
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    console.log = (...args) => {
        originalLog(...args);
        debugLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' '), 'log');
    };

    console.error = (...args) => {
        originalError(...args);
        debugLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' '), 'error');
    };

    console.warn = (...args) => {
        originalWarn(...args);
        debugLog(args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' '), 'warn');
    };

    debugLog('Debug mode initialized', 'success');

    // Import modules
    import('./src/main.js').then(module => {
        debugLog('Main module loaded', 'success');
    }).catch(err => {
        debugLog(`Failed to load main: ${err.message}`, 'error');
    });

    // Test the full stroke flow
    window.testFullStroke = async function() {
        debugLog('Starting Full Stroke test...', 'warn');

        try {
            const { predictFullStroke } = await import('./src/api/client.js');
            const { store } = await import('./src/state/store.js');
            const { navigate } = await import('./src/logic/handlers.js');

            debugLog('Modules imported successfully', 'success');

            // Test data
            const testData = {
                age_years: 65,
                systolic_bp: 160,
                diastolic_bp: 90,
                gfap_value: 850,
                fast_ed_score: 5,
                headache: false,
                vigilanzminderung: true,
                armparese: true,
                beinparese: false,
                eye_deviation: true,
                atrial_fibrillation: false,
                anticoagulated_noak: false,
                antiplatelets: false
            };

            debugLog('Calling predictFullStroke...', 'warn');
            const results = await predictFullStroke(testData);
            debugLog(`Results received: ICH=${results.ich.probability}, LVO=${results.lvo.probability}`, 'success');

            debugLog('Setting results in store...', 'warn');
            store.setResults(results);

            debugLog('Getting state...', 'warn');
            const state = store.getState();
            debugLog(`Current screen: ${state.currentScreen}`, 'log');
            debugLog(`Has results: ${state.results !== null}`, 'log');

            debugLog('Navigating to results...', 'warn');
            navigate('results');

            setTimeout(() => {
                const newState = store.getState();
                debugLog(`After navigation - Screen: ${newState.currentScreen}`, 'success');
                if (newState.currentScreen !== 'results') {
                    debugLog('Navigation failed! Trying direct store navigation...', 'error');
                    store.navigate('results');
                }
            }, 100);

        } catch (error) {
            debugLog(`Test failed: ${error.message}`, 'error');
            console.error(error);
        }
    };

    // Add test button
    setTimeout(() => {
        const container = document.getElementById('appContainer');
        if (container) {
            container.innerHTML = `
                <div class="container">
                    <h2>Debug Panel</h2>
                    <button onclick="testFullStroke()" class="primary">Test Full Stroke Module</button>
                    <button onclick="location.reload()" class="secondary">Reload Page</button>
                    <div style="margin-top: 20px;">
                        <p>Check the debug console at the bottom for detailed logs.</p>
                    </div>
                </div>
            `;
        }
    }, 1000);

    // Monitor navigation events
    window.addEventListener('popstate', (e) => {
        debugLog(`PopState event: ${JSON.stringify(e.state)}`, 'warn');
    });

    // Monitor store changes
    setInterval(() => {
        import('./src/state/store.js').then(({ store }) => {
            const state = store.getState();
            if (state.currentScreen) {
                document.title = `Debug: ${state.currentScreen}`;
            }
        }).catch(() => {});
    }, 500);
</script>
</body>
</html>