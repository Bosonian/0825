<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Rings Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug Rings Test</h1>

        <div class="test-section">
            <h2>1. Test API Client Loading</h2>
            <div id="api-test"></div>
        </div>

        <div class="test-section">
            <h2>2. Test Mock Analysis</h2>
            <button onclick="testMockAnalysis()">Run Mock Analysis</button>
            <div id="mock-test"></div>
        </div>

        <div class="test-section">
            <h2>3. Test Results Rendering</h2>
            <button onclick="testResultsRendering()">Test Results</button>
            <div id="results-test"></div>
        </div>

        <div class="test-section">
            <h2>4. Console Logs</h2>
            <div id="console-logs"></div>
        </div>
    </div>

    <script type="module">
        window.logOutput = function(message, type = 'info') {
            const logsDiv = document.getElementById('console-logs');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logsDiv.appendChild(div);
            console.log(message);
        };

        // Test 1: API Client Loading
        try {
            logOutput('Testing API client import...', 'info');
            const { predictComaIch, APIError } = await import('./src/api/client.js');
            logOutput('✅ API client loaded successfully', 'success');

            document.getElementById('api-test').innerHTML = `
                <div class="success">✅ API client loaded</div>
                <div class="debug">Functions available: predictComaIch, APIError</div>
            `;
        } catch (error) {
            logOutput('❌ Failed to load API client: ' + error.message, 'error');
            document.getElementById('api-test').innerHTML = `
                <div class="error">❌ API client failed to load: ${error.message}</div>
            `;
        }

        // Test 2: Mock Analysis Function
        window.testMockAnalysis = async function() {
            const div = document.getElementById('mock-test');
            try {
                logOutput('Starting mock analysis test...', 'info');

                const { predictComaIch } = await import('./src/api/client.js');

                // Mock payload for coma analysis
                const mockPayload = {
                    gfap_value: 150,
                    glasgow_coma_scale: 6,
                    age_years: 65
                };

                logOutput('Calling predictComaIch with mock data...', 'info');
                div.innerHTML = '<div class="info">Running analysis...</div>';

                const result = await predictComaIch(mockPayload);

                logOutput('✅ Analysis completed successfully', 'success');
                div.innerHTML = `
                    <div class="success">✅ Analysis completed</div>
                    <div class="debug">Result: ${JSON.stringify(result, null, 2)}</div>
                `;

                // Store result for results test
                window.testResult = result;

            } catch (error) {
                logOutput('❌ Analysis failed: ' + error.message, 'error');
                div.innerHTML = `
                    <div class="error">❌ Analysis failed: ${error.message}</div>
                    <div class="debug">Error stack: ${error.stack}</div>
                `;
            }
        };

        // Test 3: Results Rendering Function
        window.testResultsRendering = async function() {
            const div = document.getElementById('results-test');
            try {
                logOutput('Testing results rendering...', 'info');

                const { renderResults } = await import('./src/ui/screens/results.js');

                // Use mock data if no real result available
                const testData = window.testResult || {
                    ich: {
                        probability: 0.25,
                        module: 'Coma',
                        drivers: { gfap_value: 0.4 }
                    }
                };

                logOutput('Rendering results...', 'info');
                const resultsHtml = renderResults({ ich: testData.ich }, Date.now());

                logOutput('✅ Results rendered successfully', 'success');
                div.innerHTML = `
                    <div class="success">✅ Results rendered</div>
                    <div class="debug">HTML length: ${resultsHtml.length} characters</div>
                    <div style="max-height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
                        ${resultsHtml}
                    </div>
                `;

            } catch (error) {
                logOutput('❌ Results rendering failed: ' + error.message, 'error');
                div.innerHTML = `
                    <div class="error">❌ Results rendering failed: ${error.message}</div>
                    <div class="debug">Error stack: ${error.stack}</div>
                `;
            }
        };

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            logOutput('LOG: ' + args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logOutput('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logOutput('WARN: ' + args.join(' '), 'info');
        };

        logOutput('Debug page loaded successfully', 'success');
    </script>
</body>
</html>